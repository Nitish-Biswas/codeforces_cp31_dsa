name: Secure CI Deploy with EC2 Start Check

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ap-south-1
  ARTIFACT_BUCKET: nitish-ci-artifacts-738928894374
  INSTANCE_TAG_VALUE: output_json_server
  DEPLOY_PATH: /home/ec2-user/app

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create artifact
        shell: bash
        run: |
          set -euo pipefail

          BUILD_DIR="/tmp/build"
          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR"

          rsync -a --delete --exclude='.git' --exclude='.github' ./ "$BUILD_DIR/"

          tar -czf artifact.tar.gz -C "$BUILD_DIR" .

      - name: Configure AWS via OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-region: ${{ env.AWS_REGION }}

      - name: Get EC2 instance details
        id: instance_lookup
        shell: bash
        run: |
          set -euo pipefail

          INST=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${INSTANCE_TAG_VALUE}" \
            --query "Reservations[].Instances[0]" \
            --output json \
            --region ${AWS_REGION})

          if [ -z "$INST" ] || [ "$INST" = "null" ]; then
            echo "No EC2 instance found with tag Name=${INSTANCE_TAG_VALUE}"
            exit 1
          fi

          INSTANCE_ID=$(echo "$INST" | jq -r '.InstanceId')
          CURRENT_STATE=$(echo "$INST" | jq -r '.State.Name')

          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "state=$CURRENT_STATE" >> $GITHUB_OUTPUT

      - name: Ensure instance is running (start if stopped) & show state
        shell: bash
        run: |
          set -euo pipefail

          INSTANCE_ID="${{ steps.instance_lookup.outputs.instance_id }}"
          STATE="${{ steps.instance_lookup.outputs.state }}"

          echo "Current EC2 state: $STATE"

          if [ "$STATE" = "stopped" ]; then
            echo "Instance is stopped – starting it..."
            aws ec2 start-instances --instance-ids "$INSTANCE_ID" --region ${AWS_REGION}
          else
            echo "Instance already in state: $STATE"
          fi

      - name: Wait for RUNNING state
        shell: bash
        run: |
          set -euo pipefail
          INSTANCE_ID="${{ steps.instance_lookup.outputs.instance_id }}"

          echo "Waiting for instance to reach RUNNING state..."

          aws ec2 wait instance-running --instance-ids "$INSTANCE_ID" --region ${AWS_REGION}

          FINAL_STATE=$(aws ec2 describe-instances \
            --instance-ids "$INSTANCE_ID" \
            --query "Reservations[].Instances[0].State.Name" \
            --output text \
            --region ${AWS_REGION})

          echo "Final EC2 state: $FINAL_STATE"

      - name: Upload artifact to S3
        shell: bash
        run: |
          set -euo pipefail
          INSTANCE_ID="${{ steps.instance_lookup.outputs.instance_id }}"

          aws s3 cp artifact.tar.gz \
            s3://${ARTIFACT_BUCKET}/${INSTANCE_TAG_VALUE}/${{ github.run_id }}/artifact.tar.gz \
            --region ${AWS_REGION}

      - name: Wait for SSM Agent to be online
        shell: bash
        run: |
          set -euo pipefail
          INSTANCE_ID="${{ steps.instance_lookup.outputs.instance_id }}"

          echo "Waiting for SSM agent registration..."

          for i in {1..30}; do
            STATUS=$(aws ssm describe-instance-information \
              --filters "Key=InstanceIds,Values=$INSTANCE_ID" \
              --query "InstanceInformationList[0].PingStatus" \
              --output text \
              --region ${AWS_REGION} 2>/dev/null || echo "None")

            echo "Attempt $i – SSM PingStatus: $STATUS"

            if [ "$STATUS" = "Online" ]; then
              echo "SSM Agent is ONLINE"
              exit 0
            fi

            sleep 10
          done

          echo "SSM Agent did not come online in time."
          exit 1

      - name: Deploy to EC2 via SSM
        shell: bash
        run: |
          set -euo pipefail
          INSTANCE_ID="${{ steps.instance_lookup.outputs.instance_id }}"

          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Automated CI deploy from GitHub Actions" \
            --parameters commands="aws s3 cp s3://${ARTIFACT_BUCKET}/${INSTANCE_TAG_VALUE}/${{ github.run_id }}/artifact.tar.gz /tmp/artifact.tar.gz && \
mkdir -p ${DEPLOY_PATH} && \
tar -xzf /tmp/artifact.tar.gz -C ${DEPLOY_PATH} && \
chown -R ec2-user:ec2-user ${DEPLOY_PATH}" \
            --timeout-seconds 600 \
            --region ${AWS_REGION}
